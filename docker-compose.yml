services:

  # ðŸ§  THE ENGINE(S): FastAPI services

  # ðŸ§  Service v1
  api-v1:
    build:
      context: .
      dockerfile: src/api/v1/Dockerfile 
    # Internal-only: reachable from other services (e.g., Nginx) on the Docker network.
    # Not published to the host -> allows scaling multiple replicas without host-port conflicts.  
    expose:  
      - "8000" 

  # ðŸ§  Service v2
  api-v2:
    build:
      context: .
      dockerfile: src/api/v2/Dockerfile 
    # Internal-only: reachable from other services (e.g., Nginx) on the Docker network.
    # Not published to the host -> allows scaling multiple replicas without host-port conflicts.  
    expose:  
      - "8000" 

  # ðŸ›¡ï¸ THE GATEKEEPER: Nginx Reverse Proxy  (single entrypoint)
  nginx:
    build:
      context: deployments/nginx/
      dockerfile: Dockerfile
    # Publish HTTP entrypoint to host (use 8080 locally to avoid clashing with system port 80).  
    ports:
      - "8080:80"  # HTTP (used only to redirect -> HTTPS)
      - "443:443"  # HTTPS (Port 443 - standard TLS port) for secure communication
    volumes:
      # Mount config read-only so changes to nginx.conf take effect on container restart.
      - ./deployments/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./deployments/nginx/certs:/etc/nginx/certs:ro
      # - ./deployments/nginx/.htpasswd:/etc/nginx/.htpasswd:ro
    depends_on:
      - api-v1
      - api-v2


#   prometheus:
#     image: prom/prometheus:latest
#     container_name: prometheus_server
#     ports:
#       - "9090:9090"
#     volumes:
#       - ./deployments/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
#       - prometheus_data:/prometheus
#     depends_on:
#       - nginx

#   grafana:
#     image: grafana/grafana:latest
#     container_name: grafana_dashboard
#     ports:
#       - "3000:3000"
#     volumes:
#       - grafana_data:/var/lib/grafana
#     depends_on:
#       - prometheus
#     environment:
#       - GF_SECURITY_ADMIN_USER=admin
#       - GF_SECURITY_ADMIN_PASSWORD=admin

# volumes:
#   prometheus_data:
#   grafana_data: